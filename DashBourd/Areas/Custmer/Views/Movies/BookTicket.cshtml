@model DashBourd.Models.Movie

@{
    ViewData["Title"] = "Book Ticket - " + Model.Name;
}

<link rel="stylesheet" href="~/css/SeatBooking.css" asp-append-version="true" />

<section class="booking-section">
    <div class="container">
        <h2>Book Your Seat for <strong>@Model.Name</strong></h2>
        <h2>Cinema : <strong>@Model.Cinema?.Name</strong></h2>
        <p class="screen">SCREEN</p>

        <div class="seats-grid" id="seatsGrid">
            @for (int row = 1; row <= 6; row++)
            {
                <div class="row" data-row="@((char)('A' + row - 1))">
                    @for (int seat = 1; seat <= 8; seat++)
                    {
                        string seatId = $"{(char)('A' + row - 1)}{seat}";
                        bool isBooked = ViewBag.BookedSeats?.Contains(seatId) == true;
                        <div class="seat @(isBooked ? "booked" : "available")" data-seat="@seatId">
                            <span>@seatId</span>
                        </div>
                    }
                </div>
            }
        </div>

        <div class="legend">
            <div class="legend-item">
                <i class="blue fa-solid fa-circle"></i>
                <span>Available</span>
            </div>
            <div class="legend-item">
                <i class="green fa-solid fa-circle"></i>
                <span>Selected</span>
            </div>
            <div class="legend-item">
                <i class="Gray fa-solid fa-circle"></i>
                <span>Booked</span>
            </div>
        </div>

        <div class="summary">
            <p>Selected Seats: <span id="selectedSeats">-</span></p>
            <p>Total Price: <strong>$<span id="totalPrice">0</span></strong></p>
        </div>

        <button id="confirmBooking" class="confirm-btn" disabled>Confirm Booking</button>
    </div>
</section>

<!-- تحميل jQuery من CDN -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

@section Scripts {
    <script>
        $(document).ready(function () {
            const movieId = @Model.Id;
            const price = @Model.Price;
            let selectedSeats = [];

            // تحديث الملخص
            function updateSummary() {
                $('#selectedSeats').text(selectedSeats.length > 0 ? selectedSeats.join(', ') : '-');
                $('#totalPrice').text((selectedSeats.length * price).toFixed(2));
                $('#confirmBooking').prop('disabled', selectedSeats.length === 0);
            }

            // حدث الكراسي المتاحة فقط
            $(document).on('click', '.seat.available', function () {
                const $seat = $(this);
                const seatId = $seat.data('seat');

                if ($seat.hasClass('selected')) {
                    $seat.removeClass('selected');
                    selectedSeats = selectedSeats.filter(s => s !== seatId);
                } else {
                    $seat.addClass('selected');
                    selectedSeats.push(seatId);
                }
                updateSummary();
            });

            // تأكيد الحجز → إرسال فورم مخفي
            $('#confirmBooking').on('click', function () {
                if (selectedSeats.length === 0) return;

                const form = $('<form>', {
                    method: 'POST',
                    action: '@Url.Action("ConfirmBooking", "Movies")'
                });

                form.append($('<input>', { type: 'hidden', name: 'movieId', value: movieId }));

                selectedSeats.forEach(seat => {
                    form.append($('<input>', { type: 'hidden', name: 'seats', value: seat }));
                });

                $('body').append(form);
                form.submit();
            });

            // تهيئة
            updateSummary();
        });
    </script>
}